<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title><%= it.title %></title>
<meta name="description" content="<%= it.description %>" />

<link rel="preconnect" href="https://fonts.bunny.net" />
<link href="https://fonts.bunny.net/css?family=crimson-text:600|lato:400,700" rel="stylesheet" />
<link rel="stylesheet" href="/css/styles.css" />

<meta property="og:title" content="<%= it.title %>" />
<meta property="og:type" content="<%= it.type %>" />
<meta property="og:url" content="<%= it.url %>" />
<meta property="og:image" content="<%= it.image %>" />
<meta property="og:image:alt" content="<%= it.title %>" />

<link rel="icon" href="/favicon.ico" sizes="any" />
<link rel="icon" href="/icon.svg" type="image/svg+xml" />
<link rel="apple-touch-icon" href="/icon.png" />
</head>
<body>

<header class="container">
	<span><a href="/">RPG Adventures</a></span>
	<search>
		<form>
			<input id="search" type="search" placeholder="Search..." />
			<span class="icon"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path fill="currentColor" d="M9.5,3A6.5,6.5 0 0,1 16,9.5C16,11.11 15.41,12.59 14.44,13.73L14.71,14H15.5L20.5,19L19,20.5L14,15.5V14.71L13.73,14.44C12.59,15.41 11.11,16 9.5,16A6.5,6.5 0 0,1 3,9.5A6.5,6.5 0 0,1 9.5,3M9.5,5C7,5 5,7 5,9.5C5,12 7,14 9.5,14C12,14 14,12 14,9.5C14,7 12,5 9.5,5Z" /></svg></span>
			<menu id="results" class="hidden"></menu>
		</form>
	</search>
</header>

<div id="content" class="container">
	<nav id="primary">
		<%~ include('../components/menu', {
			menu: {
				title: 'System',
				url: '/systems',
				items: it.systems,
			}
		}) %>
		<%~ include('../components/menu', {
			menu: {
				title: 'Campaign',
				url: '/campaigns',
				items: it.campaigns,
			}
		}) %>
		<%~ include('../components/menu', {
			menu: {
				title: 'Adventure',
				url: '/adventures',
				items: it.adventures,
			}
		}) %>
	</nav>
	<main><%~ it.body %></main>
</div>

<script>

const throttle = (callback, time = 250) => {
	let timer = null

	return value => {
		if(timer !== null) {
			window.clearTimeout(timer)
		}

		timer = window.setTimeout(() => {
			callback(value);
		}, time);
	}
};

addEventListener('load', () => {
	let lastCall = ''

	const searchHandler = throttle(async input => {
		input = input.trim()

		if(input.length < 3 || input === lastCall) return

		lastCall = input

		const response = await fetch(`/search/${encodeURIComponent(input)}`, {
			headers: {
				'Content-Type': 'application/json'
			}
		})

		const results = await response.json()

		while(searchResults.firstChild) {
			searchResults.removeChild(searchResults.lastChild)
		}

		results.forEach(row => {
			const list = document.createElement('li')
			const link = document.createElement('a')

			link.setAttribute('href', row.slug)
			link.innerText = row.title

			list.appendChild(link)
			searchResults.appendChild(list)
		})

		searchResults.classList.remove('hidden')
	})

	const searchInput = document.getElementById('search')
	const searchResults = document.getElementById('results')

	searchInput.addEventListener('keyup', () => {
		searchHandler(searchInput.value)
	})

	searchInput.addEventListener('focus', () => {
		if(searchInput.value.trim() !== '') {
			searchHandler(searchInput.value)
		}
	})

	searchInput.addEventListener('blur', () => {
		window.setTimeout(() => {
			searchResults.classList.add('hidden')
			lastCall = ''
		}, 100)
	})
})

</script>

</body>
</html>
